<svg width="48" height="48" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="m437.27 211.057-38.797 79.344A142.387 142.387 0 0 0 384 352.948a142.387 142.387 0 0 1-33.951 92.28l-24.898 29.257L37.515 186.849l29.257-24.898A142.387 142.387 0 0 1 159.052 128h14.145a142.387 142.387 0 0 0 74.364-20.962l48.41-29.647a101.612 101.612 0 0 1 122.264 16.373 101.612 101.612 0 0 1 19.035 117.293z" style="fill:gold"/><path d="M352.374 309.041a32.003 32.003 0 0 0-31.892 29.817q-.482 7.023-.482 14.09a78.475 78.475 0 0 1-2.088 17.97 32 32 0 0 0 62.29 14.702l.05-.218.005-.021.019-.08.005-.023.085-.365.001-.006a142.307 142.307 0 0 0 3.419-24.153v-.003l.005-.095v-.008c.008-.127.014-.256.02-.383l.001-.012c.006-.096.01-.192.015-.289l.004-.082.002-.033.004-.076v-.028l.013-.254v-.033l.005-.075.001-.037.011-.245.001-.037.004-.072.002-.039.002-.072.002-.031.006-.136v-.043c.002-.02.003-.045.003-.066l.003-.05.002-.06.003-.061.004-.1.002-.056.001-.063.002-.05.003-.064.002-.052.004-.108.001-.053a2.03 2.03 0 0 0 .003-.064l.002-.052.002-.06.001-.055.004-.107.002-.054.002-.065.001-.048.002-.065.002-.052c0-.02 0-.04.002-.061l.002-.054c0-.037.002-.073.003-.11l.001-.051.002-.06.001-.057.002-.06.002-.065.002-.088.002-.063.002-.058v-.059l.002-.057.002-.067.002-.066.002-.088v-.046l.002-.072.001-.049.002-.077v-.037l.003-.11v-.045l.002-.075.001-.045.002-.074v-.044l.002-.11v-.035l.002-.084v-.042l.002-.08v-.038l.003-.105v-.042l.001-.083v-.044l.002-.076v-.041l.001-.1v-.02c.002-.037.002-.074.002-.112v-.038l.002-.083v-.155c.002-.04.002-.078.002-.117v-.16l.001-.082.001-.034V353.705l.001-.091v-.123l.001-.035v-.694l.001-.098v-.197l.001-.096v-.185l.001-.142.001-.042v-.098l.001-.052V351.71c.002-.034.002-.068.002-.103v-.04l.003-.285.001-.037a5.67 5.67 0 0 1 .002-.153l.001-.093.001-.054.001-.094.001-.046.005-.285v-.032l.002-.109v-.046l.003-.098v-.047l.002-.103.001-.04.003-.137v-.004l.004-.143v-.04l.003-.101.001-.05.002-.094.002-.05.002-.101v-.04l.005-.13v-.013l.004-.14v-.044c.002-.032.003-.065.003-.097l.002-.053.003-.093.001-.048.004-.1v-.043l.005-.13v-.011l.005-.142.001-.038.004-.105v-.045l.005-.097.001-.05.004-.097.001-.045.005-.124v-.017l.006-.142.002-.04.004-.1.002-.054c0-.03.002-.058.003-.087l.002-.057.004-.087.002-.054.005-.107.001-.034.006-.137.002-.046.005-.096.002-.052a3.963 3.963 0 0 1 .007-.147l.004-.085c0-.019 0-.037.002-.056l.005-.102.002-.038.006-.137.003-.05.004-.089.003-.06.005-.082.003-.061.004-.08.003-.062.005-.082.003-.076.006-.113.004-.068.004-.07.004-.074.004-.064.004-.078.004-.058.004-.08.004-.06.007-.13a3.06 3.06 0 0 1 .005-.076l.004-.072.004-.066a2.98 2.98 0 0 0 .004-.074l.005-.066.004-.074.004-.064.005-.075.004-.061.012-.177v-.026l.006-.083.004-.055.005-.081.004-.058.005-.08.005-.058c0-.019.002-.037.003-.055a32 32 0 0 0-29.74-34.11q-1.116-.076-2.218-.076zM414.269 118.065a32.03 32.03 0 0 0-31.223 39.145 38.139 38.139 0 0 1-3.271 25.734l-34.855 71.283a32 32 0 1 0 57.494 28.113l34.833-71.236.001-.002.015-.031.007-.013.06-.12.022-.045.038-.077a1.54 1.54 0 0 1 .025-.051l.035-.07.027-.054.032-.066.029-.057.031-.064.028-.057.031-.064.029-.059.03-.062.03-.06.03-.06.028-.061.03-.059.03-.062.015-.032.074-.153.025-.05.033-.07.025-.051c.01-.024.021-.046.033-.07l.024-.051.034-.07.023-.05.035-.072.022-.047.036-.075.02-.042.037-.079.017-.038a4.07 4.07 0 0 0 .04-.084l.013-.027.198-.424.009-.018.04-.089.016-.032.04-.086.015-.033.039-.085.016-.036.04-.085.014-.032.04-.088.014-.03.041-.09.01-.023c.085-.186.168-.369.251-.555l.005-.01.045-.1.008-.02c.015-.031.03-.065.043-.096l.01-.024.043-.094.011-.025.042-.095.01-.022.043-.1.007-.013c.117-.266.233-.532.347-.8l.004-.008.046-.107.006-.013.045-.105.005-.012.047-.11.001-.002a101.363 101.363 0 0 0 8.096-38.151v-.002l.002-.121v-.001c.004-.324.007-.65.009-.974v-.258l.001-.111v-.01q0-.421-.003-.841v-.138l-.002-.105v-.127l-.001-.015-.001-.111v-.01a88.98 88.98 0 0 0-.012-.721v-.008l-.002-.106v-.021l-.002-.1-.001-.027c0-.036-.001-.064-.003-.1v-.023l-.002-.101-.001-.026-.003-.1v-.023c0-.036-.002-.067-.003-.103v-.013l-.014-.467v-.013l-.003-.1-.001-.027-.003-.095-.001-.032c-.001-.032-.003-.06-.003-.093l-.002-.034-.003-.09-.001-.039a3.943 3.943 0 0 1-.003-.087l-.002-.036-.004-.092v-.028l-.004-.1v-.004l-.016-.36v-.003l-.004-.098-.001-.03-.004-.086-.002-.044-.004-.081-.002-.045-.004-.082-.002-.047-.004-.08-.002-.046-.005-.081-.002-.046a3.495 3.495 0 0 0-.004-.083l-.002-.034a4.175 4.175 0 0 1-.005-.094v-.003l-.019-.337v-.03c-.003-.028-.004-.057-.006-.085l-.002-.044-.005-.081-.003-.046-.004-.078-.004-.051-.004-.076-.004-.053-.004-.073a1.654 1.654 0 0 1-.003-.056l-.005-.072-.004-.056-.004-.07-.004-.057-.005-.074v-.014l-.012-.17-.005-.064-.004-.063-.004-.067-.005-.063a2.06 2.06 0 0 1-.009-.128l-.005-.067-.004-.061a2.245 2.245 0 0 1-.01-.127l-.005-.073-.005-.057-.005-.07-.004-.058-.006-.079-.004-.049-.009-.109-.002-.018-.01-.13-.001-.024-.01-.106-.003-.038-.007-.092-.003-.04-.008-.09-.004-.042a4.269 4.269 0 0 0-.007-.088l-.004-.043-.007-.087-.004-.044a4.033 4.033 0 0 0-.008-.09l-.004-.038-.008-.097-.003-.033a7.692 7.692 0 0 0-.011-.123v-.004l-.025-.268a8.657 8.657 0 0 1-.013-.128l-.002-.025-.01-.106-.003-.03-.01-.098-.003-.037-.01-.096-.003-.033-.01-.099-.003-.031-.01-.106-.003-.023a8.537 8.537 0 0 0-.013-.125v-.004a72.516 72.516 0 0 0-.057-.531l-.001-.015-.013-.116-.002-.02a6.375 6.375 0 0 1-.012-.112l-.003-.02-.012-.114-.002-.017-.014-.117-.001-.015-.015-.128-.097-.803v-.002a9.267 9.267 0 0 0-.016-.13v-.006l-.017-.13v-.001q-.634-5.017-1.763-9.954a32.012 32.012 0 0 0-31.165-24.87z" style="fill:#ffbe00"/><circle cx="448" cy="64" r="42.667" style="fill:gold"/><circle cx="437.333" cy="96" r="10.667" style="fill:#ffbe00"/><circle cx="448" cy="64" r="21.333" style="fill:#fff"/><path d="M417.83 70.248h17.673a15.085 15.085 0 0 1 15.085 15.085 15.085 15.085 0 0 1-15.085 15.085H417.83a15.085 15.085 0 0 1-15.085-15.085 15.085 15.085 0 0 1 15.085-15.085z" transform="rotate(-45 426.667 85.333)" style="fill:#ffea21"/><path d="M163.998 149.358a21.337 21.337 0 0 0-9.277 40.556c31.125 15 63.052 37.983 92.331 66.464a21.333 21.333 0 0 0 29.78-30.555c-28.348-27.58-58.54-50.125-88.551-66.594l-.015-.009a48.19 48.19 0 0 1-.194-.106l-.006-.003a48.422 48.422 0 0 1-.177-.097l-.031-.017-.172-.094-.028-.015-.163-.089-.048-.026-.152-.083-.05-.027-.143-.078-.07-.038c-.041-.023-.094-.05-.136-.074l-.06-.033-.146-.079-.055-.03-.154-.083-.04-.021-.16-.087-.052-.028-.147-.08-.064-.034-.133-.071a4.998 4.998 0 0 0-.084-.046l-.117-.063-.094-.05-.106-.057-.116-.062-.088-.047-.12-.064-.083-.045-.122-.065-.081-.044-.12-.063-.083-.044-.124-.066-.078-.042-.127-.068-.072-.038-.136-.072-.066-.035-.14-.075-.06-.031a32.42 32.42 0 0 0-.146-.077l-.06-.031-.142-.076-.06-.032-.15-.078-.05-.027-.15-.079-.065-.034-.145-.076-.058-.03-.154-.081-.047-.025-.162-.085-.045-.023-.171-.09-.03-.016c-.06-.03-.12-.062-.179-.093l-.027-.014-.176-.091-.032-.017-.171-.09-.033-.016-.172-.09-.032-.016-.175-.09-.025-.013-.18-.094-.023-.012-.184-.095-.017-.008a25.266 25.266 0 0 0-.188-.097l-.017-.008c-.064-.033-.122-.064-.187-.096l-.018-.01-.185-.095-.02-.01-.187-.096-.014-.008c-.065-.032-.127-.064-.19-.097l-.015-.007-.196-.1-.005-.003-.202-.103q-3.073-1.565-6.138-3.042a21.246 21.246 0 0 0-9.247-2.12z" style="fill:#ffea21"/><ellipse cx="181.333" cy="330.667" rx="99.043" ry="203.389" transform="rotate(-45 181.333 330.667)" style="fill:#ffbe00"/><path d="M280.104 469.333c-42.52 0-102.854-32.864-153.729-83.718-75.854-75.865-99.75-157.698-73.77-183.688C59.187 195.333 69.27 192 82.562 192c42.52 0 102.854 32.865 153.729 83.719 75.854 75.864 99.75 157.698 73.77 183.687-6.583 6.594-16.666 9.927-29.958 9.927z" style="fill:#ffa300"/><circle cx="266.667" cy="394.667" r="53.333" style="fill:#f98b00"/><path d="M190.55 321.615c40.443 40.427 86.729 69.161 125.427 79.377-9.588-35.862-35.947-81.528-79.685-125.273-40.444-40.427-86.73-69.162-125.427-79.378 9.587 35.862 35.946 81.529 79.684 125.274z" style="fill:#f98b00"/><circle cx="288" cy="373.333" r="53.333" style="fill:#ffea21"/><circle cx="266.667" cy="352" r="32" style="fill:#ffff9d"/><path d="m293.657 119.913 43.086-30.132a31.203 31.203 0 0 1 38.117 4.692 31.203 31.203 0 0 1-3.342 47.026l-40.389 34.143a33.622 33.622 0 0 1-38.823 1.077 33.622 33.622 0 0 1 1.351-56.806z" style="fill:#ffff9d"/><circle cx="437.333" cy="74.667" r="10.667" style="fill:#fffc74"/></svg>

# Pushmatic

A lightweight, framework-agnostic library for handling web push notifications easily.

## 🚀 Why Pushmatic?

Web push notifications allow you to engage users even when they are not actively using your website. **Pushmatic** simplifies handling web push notifications.

This package ensures **consistent behavior across all browsers** and handles browser-specific differences. For example:

- **Service Worker First**: Pushmatic ensures that the service worker is registered **before** requesting notification permission, which is required in **Edge**.
- **User-Generated Events**: It encourages requesting permission inside a **short-lived user-generated event** (e.g., a button click) because browsers like **Firefox** and **Safari** enforce this for security and user experience reasons.

Pushmatic has been **tested across all browsers that support web push notifications**, ensuring reliability and seamless integration.

### Web Push notifications

Web push notifications is actually pretty simple: when a user chooses to allow browser notifications from your website, Microsoft/Mozilla/Google create a REST endpoint somewhere in their clouds. You just need to issue a signed POST request to that endpoint with a certain payload to have notifications pushed to the user’s browser. You can send as many requests as you like, and it’s completely free.

Many developers get confused about this due to misleading articles suggesting that you need Firebase. However, since the Web Push protocol was standardized in 2016, all major browsers support it directly, eliminating the need for Firebase.

**Good read on this topic:** [How to send web push notifications for free without Firebase](https://levelup.gitconnected.com/how-to-send-web-push-notifications-for-free-with-aws-and-without-firebase-19d02eadf1f7)

## ✨ Features

- 📬 Subscribe users to push notifications
- 🔍 Check push notification permission status
- ✅ Unified API to handle everything in one function
- ⚡ Promise-based API for easy integration
- 🔗 Framework-agnostic (works with vanilla JS, React, Vue, etc.)
- 🌍 Consistent behavior across all browsers

## 📦 Installation

```sh
npm install pushmatic
```

## 🌍 Live Demo & Source Code

- Live Demo: https://pushmatic.vercel.app/

- Live Demo Source Code: https://github.com/mhmdsalahsebai/pushmatic-website

## 🔑 Generating and Using VAPID Keys

To generate VAPID keys, run:

```sh
npx web-push generate-vapid-keys --json
```

Example output:

```
Public Key:
Your generated public key

Private Key:
Your generated private key
```

- The **public key** is used on the client-side and can be stored in an environment variable.
- ⚠️ **Never store the private key in the client-side code!** The private key must remain secret and should only be used on your server to send push notifications.

## 🚀 One Function to Rule Them All

```js
import Pushmatic from "pushmatic";

Pushmatic.initializePushNotifications("/sw.js", {
  userVisibleOnly: true,
  applicationServerKey: "YOUR_PUBLIC_VAPID_KEY",
})
  .then((subscription) => {
    console.log("Subscribed:", subscription);
    // Send subscription to you server
  })
  .catch(console.error);
```

## 🛠 API Reference

### `Pushmatic.initializePushNotifications(serviceWorkerUrl, options)`

✅ **Description**:  
Registers a service worker, requests notification permission, and subscribes to push notifications in a single call.

✅ **Parameters**:

- `serviceWorkerUrl: string` → Path to the service worker file.
- `options: PushSubscriptionOptionsInit` → Push subscription options (must include `userVisibleOnly: true` and your `applicationServerKey`).

✅ **Returns**:

- `Promise<PushSubscription>` - Resolves with the subscription data.

---

## 🎯 Individual Methods (Modular Approach)

If you prefer more control, you can use the individual methods instead of `initializePushNotifications()`.

### 1️⃣ `Pushmatic.requestPermission()`

✅ **Description**:  
Requests permission from the user to enable push notifications.

✅ **Returns**:

- `Promise<string>` - Resolves with `"granted"` if permission is allowed.
- Rejects with an error if permission is denied.

✅ **Example**:

```js
Pushmatic.requestPermission()
  .then((status) => console.log("Permission status:", status))
  .catch((error) => console.error("Permission error:", error));
```

---

### 2️⃣ `Pushmatic.registerServiceWorker(scriptURL)`

✅ **Description**:  
Registers a service worker with the given script URL.

✅ **Parameters**:

- `scriptURL: string` → The path to your service worker file (e.g., `"/sw.js"`).

✅ **Returns**:

- `Promise<ServiceWorkerRegistration>` - Resolves with the service worker registration.

✅ **Example**:

```js
Pushmatic.registerServiceWorker("/sw.js")
  .then((registration) =>
    console.log("Service worker registered:", registration)
  )
  .catch((error) => console.error("Service worker error:", error));
```

---

### 3️⃣ `Pushmatic.subscribeToPush(registration, options)`

✅ **Description**:  
Subscribes the user to push notifications using the given service worker registration.

✅ **Parameters**:

- `registration: ServiceWorkerRegistration` → The service worker registration object.
- `options: PushSubscriptionOptionsInit` → Push subscription options (must include `userVisibleOnly` and `applicationServerKey`).

✅ **Returns**:

- `Promise<PushSubscription>` - Resolves with the push subscription data.

✅ **Example**:

```js
const options = {
  userVisibleOnly: true,
  applicationServerKey: "your-public-key-here",
};

Pushmatic.registerServiceWorker("/sw.js")
  .then((registration) => Pushmatic.subscribeToPush(registration, options))
  .then((subscription) => console.log("Push subscription:", subscription))
  .catch((error) => console.error("Push subscription error:", error));
```

## 📍 Where to Place the Service Worker

Your service worker file (e.g., `sw.js`) should be placed at the root of your website so that it can control the entire domain. Example content for `sw.js`:

```js
self.addEventListener("push", function (event) {
  const data = event.data.json();
  self.registration.showNotification(data.title, {
    body: data.body,
    icon: "/icon.png",
  });
});
```

📌 At this point, Pushmatic library has completed its role. The next sections serve as tutorial.

## ⚛️ Using Pushmatic in a React Component

```jsx
import { useState } from "react";
import Pushmatic from "pushmatic";

function PushButton() {
  const [subscribed, setSubscribed] = useState(false);

  function handleSubscribe() {
    Pushmatic.initializePushNotifications("/sw.js", {
      userVisibleOnly: true,
      applicationServerKey: "YOUR_PUBLIC_VAPID_KEY",
    })
      .then((subscription) => {
        console.log("Subscribed:", subscription);
        setSubscribed(true);
        sendSubscriptionToBackEnd(subscription);
      })
      .catch(console.error);
  }

  function sendSubscriptionToBackEnd(subscription) {
    return fetch("/api/save-subscription/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(subscription),
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error("Bad status code from server.");
        }
        return response.json();
      })
      .then((responseData) => {
        if (!(responseData.data && responseData.data.success)) {
          throw new Error("Bad response from server.");
        }
      });
  }

  return (
    <button onClick={handleSubscribe} disabled={subscribed}>
      {subscribed ? "Subscribed" : "Enable Notifications"}
    </button>
  );
}

export default PushButton;
```

⚠️ **Some browsers (like Firefox and Safari) require that the notification permission request be made inside a short-lived user-generated event (e.g., a button click). Otherwise, the request will be blocked.**

## 🌐 Using Pushmatic in Vanilla JavaScript

```html
<button id="push-button">Enable Notifications</button>

<script type="module">
  import Pushmatic from "pushmatic";

  document.getElementById("push-button").addEventListener("click", () => {
    Pushmatic.initializePushNotifications("/sw.js", {
      userVisibleOnly: true,
      applicationServerKey: "YOUR_PUBLIC_VAPID_KEY",
    })
      .then((subscription) => {
        console.log("Subscribed:", subscription);
      })
      .catch(console.error);
  });
</script>
```

## 🌍 Server-Side: Saving Subscriptions and Sending Push Notifications

To send notifications from your server, use the [`web-push`](https://www.npmjs.com/package/web-push) library.

### Install `web-push` on your backend

```sh
npm install web-push
```

### Storing User Subscriptions

Your backend should have an endpoint to save user subscriptions somewhere (e.g., a database):

```js
const express = require("express");
const app = express();
app.use(express.json());

const subscriptions = [];

app.post("/api/save-subscription/", (req, res) => {
  const subscription = req.body;
  subscriptions.push(subscription);
  res.status(201).json({ data: { success: true } });
});

app.listen(3000, () => console.log("Server running on port 3000"));
```

### Sending a Push Notification

```js
const webpush = require("web-push");

const vapidKeys = {
  publicKey: "Your generated public key",
  privateKey: "Your generated private key",
};

webpush.setVapidDetails(
  "mailto:your-email@example.com",
  vapidKeys.publicKey,
  vapidKeys.privateKey
);

const payload = JSON.stringify({
  title: "Hello!",
  body: "This is a push notification.",
});

subscriptions.forEach((subscription) => {
  webpush
    .sendNotification(subscription, payload)
    .then(() => console.log("Push notification sent!"))
    .catch(console.error);
});
```

🔗 **More details**: [Sending messages with Web Push libraries](https://web.dev/articles/sending-messages-with-web-push-libraries)

## 🧪 Testing

Pushmatic uses [Jest](https://jestjs.io/) for unit testing. To run tests:

```sh
npm test
```

## 🛠 Contributing

Contributions are welcome! Feel free to open issues or submit pull requests.

## 📜 License

MIT License © Mohamed Salah
